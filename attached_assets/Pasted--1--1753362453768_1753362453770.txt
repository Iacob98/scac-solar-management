# Страница «Статистика бригад»

## 1. Назначение и цель

Новая вкладка «Статистика» предназначена для аналитического обзора эффективности работы каждой бригады за произвольный период (по умолчанию — текущий месяц). Страница должна обеспечивать:

* Администратору — полный доступ ко всем бригадам, расширенные фильтры, экспорт данных и детализированные отчёты.
* Рабочим (членам бригады) — доступ только к статистике собственной бригады в пределах предоставленных прав.

## 2. Роли и права доступа (RBAC)

**Роли:**

1. **Администратор**

   * Просмотр статистики по всем бригадам.
   * Выбор произвольных периодов (дата «с» / «по»), предустановки: «Текущий месяц», «Прошлый месяц», «Квартал», «Год», «Произвольно».
   * Проваливание в детальные списки проектов любой бригады.
   * Экспорт (CSV/XLSX/PDF) и печать.
   * Настройка метрик (вкл./выкл. отдельные карточки, графики).
2. **Рабочий / Член бригады**

   * Просмотр статистики только своей бригады.
   * Период ограничен пресетами или текущим месяцем (по требованию).
   * Просмотр списка проектов, в которых участвовала бригада, но без редактирования.

**Проверка прав:**

* На уровне backend — фильтрация по `team_id`, связанного с пользователем.
* На уровне UI — скрытие недоступных элементов (селект всех бригад, расширенные фильтры, экспорт).

## 3. Ключевые метрики и определения

Определения должны быть жёстко формализованы в коде и документации:

* **«Объект завершён»** — проект/объект, имеющий статус `completed` (или эквивалентный) и дату фактического завершения в пределах выбранного периода.
* **Количество объектов за период** — количество уникальных объектов, завершённых в интервале `[date_from; date_to]`.
* **Время выполнения** — разница между датой старта участия бригады и датой завершения объекта (в среднем, медиане).
* **Загруженность** — число одновременно активных проектов в любой день периода.

Минимальный набор карточек метрик:

1. **Завершено объектов** (int)
2. **В работе сейчас** (int)
3. **Средняя длительность одного объекта** (дни)
4. **Часов/смен отработано** (если есть учёт трудозатрат)
5. **Доля просроченных объектов** (% от завершённых)

## 4. Пользовательские сценарии

### 4.1 Администратор

1. Открывает вкладку «Статистика».
2. Выбирает бригаду из выпадающего списка (по умолчанию — «Все бригады» или первая в списке).
3. Задаёт период (быстрый пресет или произвольная дата).
4. Получает набор карточек метрик + графики.
5. Кликает на карточку «Завершено объектов» → открывается модальное окно или переход на детальную таблицу с проектами.
6. Из таблицы проекта — переход к карточке проекта.

### 4.2 Рабочий

1. Открывает вкладку «Статистика».
2. Видит статистику только своей бригады, период — текущий месяц (можно расширить, если политика это допускает).
3. При клике на метрику «Проекты» — видит все проекты, где участвовала его бригада.

## 5. Структура интерфейса

### 5.1 Шапка страницы

* Заголовок: «Статистика бригад».
* **Фильтры:**

  * `Select` «Бригада» (только для админа).
  * `DateRangePicker` или две даты «с» и «по» + пресеты.
  * Кнопка «Применить» / автоприменение при изменении.
* Кнопки «Экспорт», «Печать» (админ).

### 5.2 Блок метрик (карточки)

* Сетка 2×2 или адаптивная (responsive).
* Каждая карточка: заголовок, значение, тренд (стрелка/процент, если есть сравнение с предыдущим периодом), tooltip с пояснением формулы.
* Карточка кликабельна → открывает модальное окно/панель с подробностями.

### 5.3 Визуализации

* **Гистограмма/столбчатый график** «Завершённые объекты по месяцам» внутри выбранного периода.
* **Линейный график** «Средняя длительность» по месяцам.
* **Круговая диаграмма** распределения объектов по типам работ (если типы есть).
* Для рабочих можно ограничиться одной-двумя диаграммами.

### 5.4 Таблица проектов бригады

Колонки по умолчанию:

* ID / Код проекта
* Название
* Статус (Completed / In progress / Delayed / Cancelled)
* Дата начала участия бригады
* Дата завершения
* Роль бригады (если релевантно)
* Руководитель проекта / Заказчик (опционально)

Функционал таблицы:

* Сортировка по любой колонке.
* Поиск по названию/ID.
* Пагинация (по 20–50 строк на страницу).
* Клик по строке → карточка проекта.

### 5.5 Пустые состояния и ошибки

* Если нет данных за период: отображать иллюстрацию/сообщение «Нет завершённых объектов в выбранном интервале» + предложение изменить фильтры.
* Ошибка загрузки — показывать понятный текст и кнопку «Повторить».

## 6. Логика и техническая реализация

### 6.1 Backend API (примерная структура)

```
GET /api/teams/{teamId}/stats?from=YYYY-MM-DD&to=YYYY-MM-DD
→ {  teamId, period: {from, to},
     metrics: {
        completedObjects: 12,
        inProgress: 3,
        avgDurationDays: 14.6,
        overdueShare: 0.17,
        hoursSpent: 320
     },
     charts: {
        completedByMonth: [ {month: '2025-01', count: 3}, ...],
        avgDurationByMonth: [ {month: '2025-01', days: 12}, ...],
        byType: [ {type: 'Монтаж', count: 5}, ...]
     }
}

GET /api/teams/{teamId}/projects?from=YYYY-MM-DD&to=YYYY-MM-DD&status=completed|all&page=1&size=50
→ { total, page, size, items: [ {...}, ... ] }
```

### 6.2 SQL/ORM-логика (псевдозапросы)

```sql
-- Завершённые объекты
SELECT COUNT(DISTINCT p.id) AS completed
FROM projects p
JOIN team_project tp ON tp.project_id = p.id
WHERE tp.team_id = :teamId
  AND p.status = 'completed'
  AND p.completed_at BETWEEN :from AND :to;

-- Средняя длительность участия
SELECT AVG(DATEDIFF(p.completed_at, tp.start_at)) AS avg_days
FROM projects p
JOIN team_project tp ON tp.project_id = p.id
WHERE tp.team_id = :teamId
  AND p.status = 'completed'
  AND p.completed_at BETWEEN :from AND :to;
```

### 6.3 Кэширование и производительность

* Применить server-side кэширование для тяжёлых агрегатов (например, Redis) по ключу `teamId+from+to`.
* Ограничить период запроса (например, не более 2 лет) во избежание перегрузки.
* Lazy-loading таблиц проектов (пагинация).

### 6.4 Валидация входных данных

* `teamId` должен существовать и соответствовать правам пользователя.
* `from` ≤ `to`, формат ISO-8601.
* Проверка пресетов дат на сервере, не полагаться только на UI.

## 7. Соответствие стилю сайта

* Использовать существующую дизайн-систему: цветовые токены, типографику, отступы, радиусы, тени.
* Карточки метрик — тот же компонент Card, что и на других страницах.
* Диаграммы — либо существующий компонент Chart, либо библиотека, уже применяемая в проекте (например, Chart.js / ECharts) — с настройками шрифтов и цветов из дизайн-токенов.
* Иконки и кнопки — соответствующие компонентам UI-кита проекта.
* Уведомления об ошибках — тот же Toast/Alert компонент.

## 8. Требования к качеству и тестированию

### 8.1 Acceptance Criteria

* При выборе периода и бригады данные обновляются без перезагрузки страницы (SPA-подход).
* Админ видит все бригады; рабочий — только свою.
* Числа в карточках соответствуют данным в таблице при одинаковых фильтрах.
* Графики корректно перестраиваются при смене периода.
* Пустые состояния отображаются корректно.

### 8.2 Юнит- и интеграционные тесты

* Тесты для функций агрегации статистики (backend).
* Тест на корректное формирование SQL/ORM запросов и фильтров.
* Тесты UI-компонентов (рендер карточек, графиков, таблиц).
* Тесты прав доступа (модульные + e2e).

### 8.3 Нагрузочное тестирование

* Проверка времени ответа при большом числе проектов (>10 000 записей).
* Проверка поведения при одновременных запросах от нескольких админов.

## 9. Обработка ошибок и логирование

* Backend: централизованный middleware для ошибок, логирование запросов и исключений.
* UI: отслеживание ошибок через Sentry (или аналог) с привязкой к пользователю/команде.

## 10. Будущее расширение

* Добавление KPI по качеству (количество дефектов, доработок).
* Сравнение бригад между собой (доступно только админам).
* Прогнозирование загрузки на следующий месяц.
* Интеграция с графиком смен/табелями рабочего времени.

## 11. Псевдокод фронтенд-логики

```ts
// Hooks/Stores
const teamId = useTeamSelector(); // для админа, для рабочего — из профиля
const { from, to } = useDateRange();

useEffect(() => {
  fetchStats(teamId, from, to);
  fetchProjects(teamId, from, to, page);
}, [teamId, from, to, page]);

// Обработка клика по карточке
onMetricClick(metricKey) {
  openModal(<ProjectsTable metric={metricKey} />);
}
```

## 12. Контроль корректности вычислений

* Все агрегаты должны строиться исключительно на сервере (источник истины).
* UI не должен пересчитывать формулы самостоятельно, только отображать.
* Формулы и определения метрик хранить в одном месте (константы/конфигурация), чтобы избежать рассинхронизации.

---

### Вопросы для уточнения

1. Нужно ли ограничивать рабочим выбор произвольных дат или достаточно текущего/прошлого месяца?
2. Требуется ли экспорт данных рабочим или только администраторам?
3. Какие дополнительные метрики критичны для бизнеса (например, финансовые показатели, человеко-часы, дефекты)?
4. Есть ли уже библиотека графиков в проекте, которой нужно придерживаться?
5. Нужна ли сравнение с предыдущими периодами (тренды) прямо на карточках?

Ответьте на вопросы — и я скорректирую спецификацию.
