# БИЗНЕС-ЛОГИКА СИСТЕМЫ БРИГАД

## Ключевые сущности и их взаимодействия

### 1. ФИРМА (firms)
- Каждая фирма имеет свои бригады
- Фирма имеет настройки интеграции с Google Calendar
- Фирма имеет шаблоны для календарных событий

### 2. БРИГАДА (crews)
- Принадлежит одной фирме
- Имеет уникальный номер в рамках фирмы
- Имеет руководителя и контактную информацию
- Может быть в разных статусах (активна, в отпуске, проблемы с оборудованием)
- Может иметь собственный календарь Google

### 3. УЧАСТНИК БРИГАДЫ (crew_members)
- Принадлежит одной бригаде
- Имеет роль (руководитель, рабочий, специалист)
- Имеет уникальный номер в системе
- Может иметь доступ к собственному календарю Google
- Не удаляется, а архивируется

### 4. ПРОЕКТ (projects)
- Может быть назначен на бригаду
- При назначении создается неизменяемый снимок состава бригады
- Снимок гарантирует, что отчеты о проекте показывают правильный состав

## Жизненный цикл бригады

### 1. СОЗДАНИЕ БРИГАДЫ
```sql
-- 1. Создается бригада
INSERT INTO crews (firm_id, name, unique_number, leader_name, phone, status);

-- 2. Записывается в историю
INSERT INTO crew_history (crew_id, change_type, change_description, created_by)
VALUES (NEW.id, 'crew_created', 'Бригада создана', user_id);

-- 3. Создается календарь Google (опционально)
```

### 2. ДОБАВЛЕНИЕ УЧАСТНИКА
```sql
-- 1. Добавляется участник
INSERT INTO crew_members (crew_id, first_name, last_name, unique_number, role);

-- 2. Записывается в историю
INSERT INTO crew_history (crew_id, change_type, member_id, member_name, change_description)
VALUES (crew_id, 'member_added', NEW.id, full_name, 'Участник добавлен');
```

### 3. НАЗНАЧЕНИЕ НА ПРОЕКТ (КРИТИЧЕСКИ ВАЖНО!)
```sql
-- 1. Обновляется проект
UPDATE projects SET crew_id = ? WHERE id = ?;

-- 2. Создается снимок (НЕИЗМЕНЯЕМЫЙ!)
INSERT INTO project_crew_snapshots (project_id, crew_id, crew_data, members_data, created_by)
VALUES (?, ?, crew_json, members_json, user_id);

-- 3. Создается событие в календаре
-- Используется шаблон из настроек фирмы
```

### 4. ИЗМЕНЕНИЕ СОСТАВА БРИГАДЫ
```sql
-- 1. Архивируется участник (НЕ удаляется!)
UPDATE crew_members SET archived = true WHERE id = ?;

-- 2. Записывается в историю
INSERT INTO crew_history (crew_id, change_type, member_id, end_date, change_description)
VALUES (crew_id, 'member_removed', member_id, NOW(), 'Участник исключен');

-- ВАЖНО: Существующие снимки проектов НЕ изменяются!
```

## Статусы и их значения

### СТАТУСЫ БРИГАД:
- **active**: Активная бригада, доступна для назначения на проекты
- **vacation**: В отпуске, недоступна для новых проектов
- **equipment_issue**: Проблемы с оборудованием, нужно решение
- **unavailable**: Временно недоступна по другим причинам

### РОЛИ УЧАСТНИКОВ:
- **leader**: Руководитель бригады, ответственное лицо
- **worker**: Рабочий, основной исполнитель
- **specialist**: Специалист, эксперт в определенной области

## Интеграция с Google Calendar

### ШАБЛОНЫ СОБЫТИЙ:
Из настроек фирмы используются шаблоны:
- `calendar_event_title`: "Проект: {{projectId}} - Установка солнечных панелей"
- `calendar_event_description`: Подробное описание с данными проекта

### СОЗДАНИЕ СОБЫТИЙ:
1. При назначении бригады на проект создается событие
2. Событие добавляется в календарь бригады (если настроен)
3. Событие может быть добавлено в календари участников
4. Использует даты из проекта (work_start_date, work_end_date)

## Система отчетности

### СТАТИСТИКА БРИГАД:
- Количество выполненных проектов (из project_crew_snapshots)
- Текущая загрузка (активные проекты)
- Эффективность (время выполнения проектов)
- История изменений состава

### ИСТОРИЧЕСКИЕ ДАННЫЕ:
- Все изменения сохраняются в crew_history
- Снимки в project_crew_snapshots показывают точный состав на момент работы
- Возможность восстановить состояние бригады на любую дату

## Валидация и ограничения

### УНИКАЛЬНОСТЬ:
- Номера бригад уникальны в рамках фирмы
- Номера участников уникальны в системе
- Email участников уникальны (если указаны)

### БИЗНЕС-ПРАВИЛА:
- Нельзя удалить бригаду с активными проектами
- Нельзя удалить участника - только архивировать
- При архивировании бригады все участники тоже архивируются
- Снимки проектов нельзя изменять или удалять

### РАЗРЕШЕНИЯ:
- Admin: полный доступ ко всем бригадам
- Project Leiter: доступ только к бригадам назначенных фирм
- Изменения логируются с указанием пользователя

## Миграция и совместимость

### ПРИ ОБНОВЛЕНИИ СИСТЕМЫ:
- Существующие снимки остаются неизменными
- Новые поля добавляются с DEFAULT значениями
- История изменений сохраняется полностью

### РЕЗЕРВНОЕ КОПИРОВАНИЕ:
- Особое внимание к project_crew_snapshots (критические данные)
- Регулярное архивирование crew_history
- Проверка целостности связей между таблицами